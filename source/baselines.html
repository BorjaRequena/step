<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Alternative segmentation methods to provide benchmarks.">

<title>STEP - Baselines</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="STEP - Baselines">
<meta property="og:description" content="Alternative segmentation methods to provide benchmarks.">
<meta property="og:image" content="https://BorjaRequena.github.io/step/source/03_baselines_files/figure-html/cell-13-output-1.png">
<meta property="og:site-name" content="STEP">
<meta property="og:image:height" content="413">
<meta property="og:image:width" content="546">
<meta name="twitter:title" content="STEP - Baselines">
<meta name="twitter:description" content="Alternative segmentation methods to provide benchmarks.">
<meta name="twitter:image" content="https://BorjaRequena.github.io/step/source/03_baselines_files/figure-html/cell-13-output-1.png">
<meta name="twitter:image-height" content="413">
<meta name="twitter:image-width" content="546">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">STEP</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/BorjaRequena/step" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../source/data.html">Documentation</a></li><li class="breadcrumb-item"><a href="../source/baselines.html">Baselines</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Getting started</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Documentation</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../source/data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../source/models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../source/baselines.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Baselines</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../source/utils.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Utils</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../tutorials/index_tutorials.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tutorials</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/model_training.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Model training</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/analysis_bm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Benchmark: Brownian motion</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/analysis_andi.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Benchmark: anomalous diffusion</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/anomalous_from_normal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Anomalous diffusion from normal diffusion</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#diffusion-properties" id="toc-diffusion-properties" class="nav-link active" data-scroll-target="#diffusion-properties">Diffusion properties</a>
  <ul class="collapse">
  <li><a href="#tamsd" id="toc-tamsd" class="nav-link" data-scroll-target="#tamsd">tamsd</a></li>
  <li><a href="#anomalous_exponent_tamsd" id="toc-anomalous_exponent_tamsd" class="nav-link" data-scroll-target="#anomalous_exponent_tamsd">anomalous_exponent_tamsd</a></li>
  <li><a href="#diffusion_coefficient_tamsd" id="toc-diffusion_coefficient_tamsd" class="nav-link" data-scroll-target="#diffusion_coefficient_tamsd">diffusion_coefficient_tamsd</a></li>
  </ul></li>
  <li><a href="#changepoint-detection-methods" id="toc-changepoint-detection-methods" class="nav-link" data-scroll-target="#changepoint-detection-methods">Changepoint detection methods</a>
  <ul class="collapse">
  <li><a href="#local-convex-hull-method" id="toc-local-convex-hull-method" class="nav-link" data-scroll-target="#local-convex-hull-method">Local convex hull method</a>
  <ul class="collapse">
  <li><a href="#hull_diameter" id="toc-hull_diameter" class="nav-link" data-scroll-target="#hull_diameter">hull_diameter</a></li>
  <li><a href="#convex_hull_cp" id="toc-convex_hull_cp" class="nav-link" data-scroll-target="#convex_hull_cp">convex_hull_cp</a></li>
  </ul></li>
  <li><a href="#ruptures" id="toc-ruptures" class="nav-link" data-scroll-target="#ruptures">Ruptures</a>
  <ul class="collapse">
  <li><a href="#ruptures_cp" id="toc-ruptures_cp" class="nav-link" data-scroll-target="#ruptures_cp">ruptures_cp</a></li>
  </ul></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/BorjaRequena/step/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Baselines</h1>
</div>

<div>
  <div class="description">
    Alternative segmentation methods to provide benchmarks.
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="diffusion-properties" class="level1">
<h1>Diffusion properties</h1>
<p>The diffusion properties of a particle are capture in its mean squared displacement (MSD) <span class="math inline">\(\langle x^2\rangle = 2d Dt^\alpha\)</span>, where <span class="math inline">\(d\)</span> is the dimension, <span class="math inline">\(D\)</span> is the diffusion coefficient and <span class="math inline">\(\alpha\)</span> is the anomalous diffusion exponent. A common technique to study single-particle diffusion is to estimate the MSD with the time-averaged mean squared displacement (TA-MSD).</p>
<hr>
<p><a href="https://github.com/BorjaRequena/step/blob/main/step/baselines.py#L14" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="tamsd" class="level3">
<h3 class="anchored" data-anchor-id="tamsd">tamsd</h3>
<blockquote class="blockquote">
<pre><code> tamsd (x:torch.Tensor, dt:int=1)</code></pre>
</blockquote>
<p>Time-averaged mean squared displacement of a trajectory <code>x</code> in <code>dt</code> intervals.</p>
<table class="table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>x</td>
<td>Tensor</td>
<td></td>
<td>Input trajectory of shape [length, dim]</td>
</tr>
<tr class="even">
<td>dt</td>
<td>int</td>
<td>1</td>
<td>t-lag: time interval to compute displacements</td>
</tr>
<tr class="odd">
<td><strong>Returns</strong></td>
<td><strong>float</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>From the TA-MSD, we can compute both <span class="math inline">\(D\)</span> and <span class="math inline">\(\alpha\)</span> looking at its scaling with <span class="math inline">\(t\)</span>. In Brownian motion, we can extract the diffusion coefficient through a linear fit of the TA-MSD <span class="math inline">\(\propto 2dDt\)</span> over time, as the slope is <span class="math inline">\(2dD\)</span>. In anomalous diffusion, we can perform a linear fit in logarithmic space, since it follows a power-law TA-MSD <span class="math inline">\(\propto t^\alpha\)</span>.</p>
<hr>
<p><a href="https://github.com/BorjaRequena/step/blob/main/step/baselines.py#L32" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="anomalous_exponent_tamsd" class="level3">
<h3 class="anchored" data-anchor-id="anomalous_exponent_tamsd">anomalous_exponent_tamsd</h3>
<blockquote class="blockquote">
<pre><code> anomalous_exponent_tamsd (x:torch.Tensor, t_lag:Iterable=[])</code></pre>
</blockquote>
<p>Estimates the anomalous exponent fitting the <code>tmsd</code> in log-log scale for different t-lags.</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>x</td>
<td>Tensor</td>
<td></td>
<td>Input trajectory of shape [length, dim]</td>
</tr>
<tr class="even">
<td>t_lag</td>
<td>Iterable</td>
<td>[]</td>
<td>t-lags to consider. Defautls to [2,…,max(5, 10% length)]</td>
</tr>
<tr class="odd">
<td><strong>Returns</strong></td>
<td><strong>float</strong></td>
<td></td>
<td><strong>Anomalous exponent</strong></td>
</tr>
</tbody>
</table>
<hr>
<p><a href="https://github.com/BorjaRequena/step/blob/main/step/baselines.py#L23" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="diffusion_coefficient_tamsd" class="level3">
<h3 class="anchored" data-anchor-id="diffusion_coefficient_tamsd">diffusion_coefficient_tamsd</h3>
<blockquote class="blockquote">
<pre><code> diffusion_coefficient_tamsd (x:torch.Tensor, t_lag:Iterable=[1, 2])</code></pre>
</blockquote>
<p>Estimates the diffusion coefficient fitting the <code>tmsd</code> for different <code>dt</code>.</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>x</td>
<td>Tensor</td>
<td></td>
<td>Input trajectory of shape [length, dim]</td>
</tr>
<tr class="even">
<td>t_lag</td>
<td>Iterable</td>
<td>[1, 2]</td>
<td>t-lags to consider for the fit. [1, 2] is optimal for Brownian motion</td>
</tr>
<tr class="odd">
<td><strong>Returns</strong></td>
<td><strong>float</strong></td>
<td></td>
<td><strong>Diffusion coefficient</strong></td>
</tr>
</tbody>
</table>
<p>Let’s see an example with Brownian motion. First, with our <a href="https://BorjaRequena.github.io/step/source/data.html#brownian_motion"><code>brownian_motion</code></a> function, we can simulate a few trajectories with different diffusion coefficients.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>max_t <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>Ds <span class="op">=</span> np.array([<span class="fl">0.5</span>, <span class="fl">1.</span>, <span class="fl">5.</span>, <span class="dv">20</span>])[:, <span class="va">None</span>, <span class="va">None</span>] <span class="co"># Extra dimensions to broadcast</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>dim <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">7</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>trajs <span class="op">=</span> tensor(brownian_motion(<span class="bu">len</span>(Ds), max_t, Ds, dim<span class="op">=</span>dim))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s compute the diffusion coefficients for the trajectories.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>[diffusion_coefficient_tamsd(traj.T) <span class="cf">for</span> traj <span class="kw">in</span> trajs]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[0.5010303556919097, 0.9403451681137086, 4.982022762298584, 19.222974777221676]</code></pre>
</div>
</div>
<p>We can do a similar analysis for anomalous diffusion. Let’s use the <a href="">andi_datasets</a> library to generate a few fractional brownian motion trajectories with different <span class="math inline">\(\alpha\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>ad <span class="op">=</span> datasets_theory()</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>alphas <span class="op">=</span> [<span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">1.</span>, <span class="fl">1.5</span>]</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">7</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>trajs <span class="op">=</span> ad.create_dataset(T<span class="op">=</span>max_t, N_models<span class="op">=</span><span class="dv">1</span>, exponents<span class="op">=</span>alphas,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                          models<span class="op">=</span>[<span class="dv">2</span>], dimension<span class="op">=</span>dim)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>trajs <span class="op">=</span> tensor(trajs[:, <span class="dv">2</span>:]).reshape(<span class="bu">len</span>(alphas), max_t, dim)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>[anomalous_exponent_tamsd(traj) <span class="cf">for</span> traj <span class="kw">in</span> trajs]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[0.1301758215732175,
 0.47395024375992173,
 0.9880268080088149,
 1.4136567214095137]</code></pre>
</div>
</div>
</section>
</section>
<section id="changepoint-detection-methods" class="level1">
<h1>Changepoint detection methods</h1>
<section id="local-convex-hull-method" class="level2">
<h2 class="anchored" data-anchor-id="local-convex-hull-method">Local convex hull method</h2>
<p>The <a href="https://journals.aps.org/pre/abstract/10.1103/PhysRevE.96.022144">local convex hull method</a> allows us to detect changepoints between two diffusive states in a trajectory. However, it does not provide any information about the properties of the segments.</p>
<hr>
<p><a href="https://github.com/BorjaRequena/step/blob/main/step/baselines.py#L42" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="hull_diameter" class="level3">
<h3 class="anchored" data-anchor-id="hull_diameter">hull_diameter</h3>
<blockquote class="blockquote">
<pre><code> hull_diameter (hull)</code></pre>
</blockquote>
<p>Diameter of the local convex hull.</p>
<hr>
<p><a href="https://github.com/BorjaRequena/step/blob/main/step/baselines.py#L48" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="convex_hull_cp" class="level3">
<h3 class="anchored" data-anchor-id="convex_hull_cp">convex_hull_cp</h3>
<blockquote class="blockquote">
<pre><code> convex_hull_cp (traj:numpy.ndarray, tau:int=10, method:str='volume')</code></pre>
</blockquote>
<p>Detect the changepoints in <code>traj</code> with the local convex hull method.</p>
<table class="table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>traj</td>
<td>ndarray</td>
<td></td>
<td>Trajectory to study</td>
</tr>
<tr class="even">
<td>tau</td>
<td>int</td>
<td>10</td>
<td>Size of the sliding window</td>
</tr>
<tr class="odd">
<td>method</td>
<td>str</td>
<td>volume</td>
<td>Property of interest: “volume” or “diameter”</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>ndarray</strong></td>
<td></td>
<td><strong>Changepoints along the trajectory</strong></td>
</tr>
</tbody>
</table>
<p>This method relies on computing properties of the local convex hull conformed by a set of <span class="math inline">\(\tau\)</span> points along a trajectory. Whenever we encounter large changes in these properties, it signals a change in the diffusion mode. We typically consider the volume or the diameter of the hull.</p>
<p>To identify the changes, the method relies on a simple heuristic: we compute the mean of the property of interest along the trajectory and we mark a changepoint whenever we cross the mean value.</p>
<p>Let’s see an example with a trajectory. We consider a 2D Brownian motion trajectory with two diffusive modes: a slow and a fast one. To simulate the fast one, we multiply the trajectory displacements by a factor <span class="math inline">\(\gt1\)</span>, effectively increasing the diffusion coefficient by its square.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>T <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>cps <span class="op">=</span> np.array([<span class="dv">400</span>, <span class="dv">600</span>])</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">7</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>traj <span class="op">=</span> np.random.randn(T, <span class="dv">2</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>traj[<span class="bu">slice</span>(<span class="op">*</span>cps)] <span class="op">=</span> <span class="fl">2.5</span><span class="op">*</span>traj[<span class="bu">slice</span>(<span class="op">*</span>cps)] <span class="co"># 2.5x factor displacements between cps</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>traj <span class="op">=</span> traj.cumsum(<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The resulting trajectory has two changepoints in which we switch from slow to fast and fast to slow, respectively.</p>
<p>To build some intuition about convex hulls, let’s look at the local convex hull of the first 10 points of the trajectory.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>points <span class="op">=</span> traj[:<span class="dv">10</span>]</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>hull <span class="op">=</span> ConvexHull(points)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>plt.plot(hull.points[:, <span class="dv">0</span>], hull.points[:, <span class="dv">1</span>], <span class="st">'o-'</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> simplex <span class="kw">in</span> hull.simplices:</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    plt.plot(hull.points[simplex, <span class="dv">0</span>], hull.points[simplex, <span class="dv">1</span>], <span class="st">'k-'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="03_baselines_files/figure-html/cell-13-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>To distinguish between both diffusive states, we compute the local convex hull properties (diameter and volume) over a sliding window of size <span class="math inline">\(\tau\)</span> along the trajectories.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>tau <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>max_t <span class="op">=</span> traj.shape[<span class="dv">0</span>] <span class="op">-</span> <span class="dv">2</span><span class="op">*</span>tau</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>Sd <span class="op">=</span> np.zeros(max_t)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>Sv <span class="op">=</span> np.zeros(max_t)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(max_t):   </span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    hull <span class="op">=</span> ConvexHull(traj[k:(k<span class="op">+</span><span class="dv">2</span><span class="op">*</span>tau)])</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    Sd[k] <span class="op">=</span> hull_diameter(hull)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    Sv[k] <span class="op">=</span> hull.volume</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This allows us to extract the changepoints by looking at the points where the diameter or volume over time cross their mean value over time. This is what we do to find the changepoints in <a href="https://BorjaRequena.github.io/step/source/baselines.html#convex_hull_cp"><code>convex_hull_cp</code></a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>changepoints_vol <span class="op">=</span> convex_hull_cp(traj, tau<span class="op">=</span>tau, method<span class="op">=</span><span class="st">"volume"</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>changepoints_diam <span class="op">=</span> convex_hull_cp(traj, tau<span class="op">=</span>tau, method<span class="op">=</span><span class="st">"diameter"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the figures below, we see all the information together. The changepoints (red dots) are always marked in the time-step prior to crossing the mean-value line.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="fl">3.5</span>), constrained_layout<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot(Sd)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].scatter(changepoints_diam, Sd[changepoints_diam], c<span class="op">=</span><span class="st">'r'</span>, label<span class="op">=</span><span class="st">"Changepoints"</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axhline(Sd.mean(), label<span class="op">=</span><span class="st">'Mean'</span>, c<span class="op">=</span><span class="st">'C1'</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend()</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].fill_betweenx(np.arange(Sd.<span class="bu">max</span>()), on, off, zorder<span class="op">=-</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.1</span>, color<span class="op">=</span><span class="st">'k'</span>, lw<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">'Time'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)<span class="op">;</span> axes[<span class="dv">0</span>].set_ylabel(<span class="vs">r'$S_d$'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">"Local convex hull diameter"</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].plot(Sv)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].scatter(changepoints_vol, Sv[changepoints_vol], c<span class="op">=</span><span class="st">'r'</span>, label<span class="op">=</span><span class="st">"Changepoints"</span>)</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].axhline(Sv.mean(), label<span class="op">=</span><span class="st">'Mean'</span>, c<span class="op">=</span><span class="st">'C1'</span>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].legend()</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].fill_betweenx(np.arange(Sv.<span class="bu">max</span>()), on, off, zorder<span class="op">=-</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.1</span>, color<span class="op">=</span><span class="st">'k'</span>, lw<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Time'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)<span class="op">;</span> axes[<span class="dv">1</span>].set_ylabel(<span class="vs">r'$S_v$'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">"Local convex hull volume"</span>, fontsize<span class="op">=</span><span class="dv">16</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="03_baselines_files/figure-html/cell-16-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="ruptures" class="level2">
<h2 class="anchored" data-anchor-id="ruptures">Ruptures</h2>
<p>The <a href="https://centre-borelli.github.io/ruptures-docs/">ruptures library</a> implements a kernel change point detection algorithm (see their <a href="https://www.sciencedirect.com/science/article/abs/pii/S0165168419303494?via%3Dihub">review paper</a>) performing a piecewise constant fit of the input signal.</p>
<p>The algorithm can either take a fixed number of changepoints to allocate, or infer the number by balancing the accuracy of the fit with a penalty for adding new changepoints. In most of our applications, we do not know the number of changepoints beforehand (which is the beauty of <a href="https://arxiv.org/abs/2302.00410">STEP</a>!).</p>
<hr>
<p><a href="https://github.com/BorjaRequena/step/blob/main/step/baselines.py#L68" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="ruptures_cp" class="level3">
<h3 class="anchored" data-anchor-id="ruptures_cp">ruptures_cp</h3>
<blockquote class="blockquote">
<pre><code> ruptures_cp (x:numpy.ndarray, pen:float=1.0, kernel='linear', min_size=2,
              jump=1, params=None)</code></pre>
</blockquote>
<p>Returns the change points of signal <code>x</code>, excluding the initial and final times.</p>
<table class="table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>x</td>
<td>ndarray</td>
<td></td>
<td>Input signal with shape [length, dim]</td>
</tr>
<tr class="even">
<td>pen</td>
<td>float</td>
<td>1.0</td>
<td>Penalty for the changepoint prediction</td>
</tr>
<tr class="odd">
<td>kernel</td>
<td>str</td>
<td>linear</td>
<td></td>
</tr>
<tr class="even">
<td>min_size</td>
<td>int</td>
<td>2</td>
<td></td>
</tr>
<tr class="odd">
<td>jump</td>
<td>int</td>
<td>1</td>
<td></td>
</tr>
<tr class="even">
<td>params</td>
<td>NoneType</td>
<td>None</td>
<td></td>
</tr>
<tr class="odd">
<td><strong>Returns</strong></td>
<td><strong>ndarray</strong></td>
<td></td>
<td><strong>Changepoints along the trajectory</strong></td>
</tr>
</tbody>
</table>
<p>This algorithm is particularly well-suited to post-process our model predictions, which are (quasi) pointwise constant. Furthermore, unlike the local convex hull method, it is not limited to just two “states”.</p>
<p>Let’s see an example of what could be a typical application of <a href="https://BorjaRequena.github.io/step/source/baselines.html#ruptures_cp"><code>ruptures_cp</code></a>. First, we will create a synthetic model prediction with some noise.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>max_t <span class="op">=</span> <span class="dv">250</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>cps <span class="op">=</span> [<span class="dv">20</span>, <span class="dv">70</span>, <span class="dv">150</span>]</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>values <span class="op">=</span> [<span class="op">-</span><span class="fl">1.</span>, <span class="fl">3.</span>, <span class="fl">1.</span>, <span class="fl">2.</span>]</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">7</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> np.concatenate([[v]<span class="op">*</span>(c1 <span class="op">-</span> c0) <span class="cf">for</span> v, c0, c1 <span class="kw">in</span> <span class="bu">zip</span>(values, [<span class="dv">0</span>]<span class="op">+</span>cps, cps<span class="op">+</span>[max_t])])</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>pred <span class="op">+=</span> <span class="fl">0.5</span><span class="op">*</span>np.random.randn(<span class="op">*</span>pred.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s perform the changepoint detection over this noisy prediction considering different penalties.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>penalties <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">100</span>]</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>cps_pens <span class="op">=</span> [ruptures_cp(pred, pen<span class="op">=</span>pen) <span class="cf">for</span> pen <span class="kw">in</span> penalties]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">4</span>))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>plt.plot(pred, label<span class="op">=</span><span class="st">"Prediction"</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> pen, cp <span class="kw">in</span> <span class="bu">zip</span>(penalties, cps_pens):</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    segment_fit <span class="op">=</span> [[pred[c0:c1].mean()]<span class="op">*</span>(c1<span class="op">-</span>c0) <span class="cf">for</span> c0, c1 <span class="kw">in</span> <span class="bu">zip</span>([<span class="dv">0</span>]<span class="op">+</span>cp, cp<span class="op">+</span>[max_t])]</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    plt.plot(np.concatenate(segment_fit), label<span class="op">=</span><span class="ss">f"Fit pen=</span><span class="sc">{</span>pen<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Time"</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Pred"</span>, fontsize<span class="op">=</span><span class="dv">14</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="03_baselines_files/figure-html/cell-20-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>For this case, a penalty of <span class="math inline">\(5\)</span> is just right to recover the ground truth value of our signal. However, if we didn’t know the ground truth beforehand, a penalty of <span class="math inline">\(2\)</span> would also provide a reasonable result.</p>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>